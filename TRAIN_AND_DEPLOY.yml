name:TRAIN_AND_DEPLOY

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/ml-inference-service
  PYTHON_VERSION: "3.11"

jobs:
  train:
    name: Train Model (CI)
    runs-on: ubuntu-latest
    
    outputs:
      f1_score: ${{ steps.extract_metrics.outputs.f1_score }}
      mse: ${{ steps.extract_metrics.outputs.mse }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Train model
        run: |
          python scripts/train.py
      
      - name: Extract metrics
        id: extract_metrics
        run: |
          F1_SCORE=$(python -c "import json; print(json.load(open('metrics.json'))['f1_score'])")
          MSE=$(python -c "import json; print(json.load(open('metrics.json'))['mse'])")
          echo "f1_score=$F1_SCORE" >> $GITHUB_OUTPUT
          echo "mse=$MSE" >> $GITHUB_OUTPUT
          echo "ðŸ“Š F1 Score: $F1_SCORE"
          echo "ðŸ“Š MSE: $MSE"
      
      - name: Upload model and metrics
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts
          path: |
            model.pkl
            metrics.json
            
  deploy:
    name: Deploy Model (CD)
    runs-on: ubuntu-latest
    needs: train
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download model artifacts
        uses: actions/download-artifact@v4
        with:
          name: model-artifacts
      
      - name: Compare metrics and decide deployment
        id: compare_metrics
        env:
          CURRENT_F1: ${{ needs.train.outputs.f1_score }}
          CURRENT_MSE: ${{ needs.train.outputs.mse }}
          BEST_F1: ${{ vars.BEST_F1_SCORE }}
          BEST_MSE: ${{ vars.BEST_MSE }}
        run: |
          echo "Current F1 Score: $CURRENT_F1"
          echo "Best F1 Score: $BEST_F1"
          echo "Current MSE: $CURRENT_MSE"
          echo "Best MSE: $BEST_MSE"
          
          # Default best values if not set
          BEST_F1=${BEST_F1:-0}
          BEST_MSE=${BEST_MSE:-999999}
          
          # Compare metrics (F1 should be higher, MSE should be lower)
          SHOULD_DEPLOY=false
          
          if (( $(echo "$CURRENT_F1 > $BEST_F1" | bc -l) )); then
            echo "âœ… F1 Score improved: $BEST_F1 â†’ $CURRENT_F1"
            SHOULD_DEPLOY=true
          elif (( $(echo "$CURRENT_F1 == $BEST_F1" | bc -l) )) && (( $(echo "$CURRENT_MSE < $BEST_MSE" | bc -l) )); then
            echo "âœ… MSE improved: $BEST_MSE â†’ $CURRENT_MSE"
            SHOULD_DEPLOY=true
          else
            echo "âŒ 2022BCD0026----Metric did not improve"
            SHOULD_DEPLOY=false
          fi
          
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
      
      - name: Set up Docker Buildx
        if: steps.compare_metrics.outputs.should_deploy == 'true'
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Docker Hub
        if: steps.compare_metrics.outputs.should_deploy == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build and push Docker image
        if: steps.compare_metrics.outputs.should_deploy == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_NAME }}:latest
            ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Update best metrics
        if: steps.compare_metrics.outputs.should_deploy == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Update BEST_F1_SCORE variable
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/actions/variables/BEST_F1_SCORE \
            -f name='BEST_F1_SCORE' \
            -f value='${{ needs.train.outputs.f1_score }}' || \
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/actions/variables \
            -f name='BEST_F1_SCORE' \
            -f value='${{ needs.train.outputs.f1_score }}'
          
          # Update BEST_MSE variable
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/actions/variables/BEST_MSE \
            -f name='BEST_MSE' \
            -f value='${{ needs.train.outputs.mse }}' || \
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/actions/variables \
            -f name='BEST_MSE' \
            -f value='${{ needs.train.outputs.mse }}'
          
          echo "âœ… Updated baseline metrics"
          echo "New Best F1 Score: ${{ needs.train.outputs.f1_score }}"
          echo "New Best MSE: ${{ needs.train.outputs.mse }}"
      
      - name: Deployment Summary
        if: steps.compare_metrics.outputs.should_deploy == 'true'
        run: |
          echo "ðŸš€ Deployment successful!"
          echo "Docker Image: ${{ env.DOCKER_IMAGE_NAME }}:latest"
          echo "F1 Score: ${{ needs.train.outputs.f1_score }}"
          echo "MSE: ${{ needs.train.outputs.mse }}"
